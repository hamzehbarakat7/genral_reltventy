<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محاكي الزمكان 3D</title>
  <style>
:root{
  --bg:#0b0f16; --panel:#0f1624; --accent:#59c1ff; --muted:#9fb3c8;
  --good:#7ee787; --warn:#ffd166; --bad:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow:hidden}
body{background:var(--bg);color:#e6edf3;font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0c1420;border-bottom:1px solid #152033;z-index:5}
header h1{font-size:16px;margin:0;color:#d6e7ff}
header .badge{padding:3px 8px;border:1px solid #22324a;border-radius:9999px;color:#c2d4ee;font-size:12px}
header .legend{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}

.wrap{display:flex;flex-direction:column;height:calc(100vh - 44px)}
.main-content{flex:1;position:relative;overflow:hidden;background:radial-gradient(1400px 900px at 50% 40%, #0f1a2a 0, #0b0f16 70%)}
aside{background:var(--panel);border-top:1px solid #152033;padding:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;max-height:35vh;overflow-y:auto}
.group{border:1px solid #1f2a3d;border-radius:10px;padding:10px}
.group h3{margin:0 0 8px 0;font-size:13px;color:#cfe3ff}
.group h4{margin:0 0 6px 0;font-size:12px;color:#b9d3ff}
label{display:grid;grid-template-columns: 1fr auto; gap:6px; align-items:center;margin:5px 0;font-size:12px}
input[type="number"], input[type="text"], select{width:140px;background:#0c1320;color:#e6edf3;border:1px solid #1f2a3d;border-radius:6px;padding:5px;font-size:12px}
input[type="checkbox"]{transform:scale(1.1)}
input[type="range"]{width:100%}
button{background:#122035;border:1px solid #283a57;color:#e6f2ff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:12px}
button:hover{border-color:#3c577f;background:#1a2a45}
.row{display:flex;gap:8px;flex-wrap:wrap}
.row > *{flex:1}
.pill{padding:4px 8px;border-radius:9999px;border:1px solid #22324a;color:#c9ddff;font-size:11px}

#view{display:block;width:100%;height:100%}
.hud{position:absolute;left:10px;top:10px;background:rgba(15,22,36,.9);border:1px solid #1f2a3d;border-radius:10px;padding:10px;backdrop-filter:blur(6px);min-width:260px;max-width:300px}
.grid{display:grid;grid-template-columns:auto 1fr;gap:4px 10px;align-items:center;font-size:11px}
.kbd{font-family:ui-monospace,monospace;padding:2px 6px;border:1px solid #26344d;border-radius:4px;background:#0e1829;color:#c9d9f7;font-size:11px}

.cards{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
.card{background:#0e1626;border:1px solid #1f2a3d;border-radius:8px;padding:8px;font-size:11px}
.card h4{margin:0 0 6px 0;font-size:12px;color:#cfe3ff;display:flex;justify-content:space-between;align-items:center}
.card .meta{display:grid;grid-template-columns:auto 1fr;gap:3px 8px;color:#9fb3c8}
.card .rowBtns{display:flex;gap:4px;margin-top:6px}
.card button{padding:4px 8px;font-size:10px}
.muted{color:#9fb3c8;font-size:11px}
.badgeSmall{padding:2px 5px;border:1px solid #28405e;border-radius:999px;color:#9fd1ff;font-size:10px}
.selected{outline:2px solid var(--accent)}
#chart{display:block;margin-top:8px;width:100%;height:90px}
  </style>
</head>
<body>
  <header>
    <h1>محاكي الزمكان 3D</h1>
    <span class="badge">RK4 + تكيفي + 1PN + 3D</span>
    <div class="legend">
      <span class="pill">إسقاط 3D</span>
      <span class="pill">مسارات</span>
    </div>
  </header>

  <div class="wrap">
    <div class="main-content">
      <canvas id="view"></canvas>
      <div class="hud">
        <h4>لوحة فيزيائية</h4>
        <div class="grid" id="stats"></div>
        <canvas id="chart"></canvas>
      </div>
    </div>

    <aside>
      <div class="group">
        <h3>التحكم</h3>
        <div class="row">
          <button id="btnPlay">▶ تشغيل</button>
          <button id="btnStep">⏭ خطوة</button>
          <button id="btnReset">⟲ إعادة</button>
        </div>
        <label>السرعة
          <input type="number" id="speedMul" step="0.5" value="1" style="width:80px" />
        </label>
        <label>Δt (ث)
          <input type="number" id="dt" step="0.1" value="1" style="width:80px" />
        </label>
        <label><input type="checkbox" id="adaptive" checked /> تكيفي</label>
        <label><input type="checkbox" id="enablePN" /> 1PN</label>
        <label>التصادم
          <select id="collisionMode" style="width:100px">
            <option value="none">بدون</option>
            <option value="merge">دمج</option>
          </select>
        </label>
      </div>

      <div class="group">
        <h4>كاميرا 3D</h4>
        <label>تكبير
          <input id="zoomRange" type="range" min="-100" max="100" step="2" value="0" />
        </label>
        <label>دوران أفقي
          <input id="rotY" type="range" min="0" max="360" step="2" value="45" />
        </label>
        <label>دوران عمودي
          <input id="rotX" type="range" min="-90" max="90" step="2" value="30" />
        </label>
        <small class="muted" id="zoomLabel">—</small>
      </div>

      <div class="group">
        <h3>مشاهد جاهزة</h3>
        <select id="preset" style="width:100%">
          <option value="solar">نظام شمسي</option>
          <option value="binary">نجمان ثنائيان</option>
          <option value="three">مشكلة الثلاثة</option>
          <option value="bhStar">ثقب أسود</option>
          <option value="random">عشوائي</option>
        </select>
        <button id="btnLoadPreset" style="width:100%;margin-top:6px">تحميل</button>
      </div>

      <div class="group">
        <h3>إضافة جرم</h3>
        <label>اسم <input id="bName" value="Body" style="width:100px"/></label>
        <label>كتلة <input id="bMass" type="number" value="5.972e24" style="width:100px"/></label>
        <label>x <input id="bX" type="number" value="1.5e11" style="width:100px"/></label>
        <label>y <input id="bY" type="number" value="0" style="width:100px"/></label>
        <label>z <input id="bZ" type="number" value="0" style="width:100px"/></label>
        <label>vx <input id="bVX" type="number" value="0" style="width:100px"/></label>
        <label>vy <input id="bVY" type="number" value="29780" style="width:100px"/></label>
        <label>vz <input id="bVZ" type="number" value="0" style="width:100px"/></label>
        <div class="row" style="margin-top:6px">
          <button id="btnAdd">➕ إضافة</button>
          <button id="btnClear">🗑️ حذف</button>
        </div>
      </div>

      <div class="group">
        <h3>خيارات</h3>
        <label><input type="checkbox" id="showTrails" checked /> المسارات</label>
        <label><input type="checkbox" id="showGrid" checked /> الشبكة</label>
        <label>تتبع <select id="track" style="width:100px"></select></label>
        <button id="btnCSV" style="width:100%">💾 حفظ CSV</button>
      </div>

      <div class="group">
        <h3>بطاقات الأجسام</h3>
        <div id="bodyCards" class="cards"></div>
      </div>
    </aside>
  </div>

  <script>
// === ثوابت ===
const C = 299792458, G = 6.67430e-11;

// === حالة ===
let bodies = [], time = 0, running = false, currentDt = 0;
const state = {dt:1, minDt:1e-5, maxDt:10, adaptive:true, pn:false, speedMul:1, collision:'none', trails:true, showGrid:true};

// === DOM ===
const view = document.getElementById('view');
const ctx = view.getContext('2d');
const hudStats = document.getElementById('stats');
const chart = document.getElementById('chart');
const cctx = chart.getContext('2d');
const cardsRoot = document.getElementById('bodyCards');
const q = id => document.getElementById(id);

// === كاميرا 3D (إسقاط منظوري) ===
let cam = {dist: 5e11, rotX: 30, rotY: 45, scale: 1};

function resize(){
  view.width = view.clientWidth;
  view.height = view.clientHeight;
  chart.width = chart.clientWidth;
  chart.height = 90;
}
window.addEventListener('resize', resize);
resize();

function updateCamera(){
  cam.dist = 2e11 * Math.exp(parseFloat(q('zoomRange').value) * 0.015);
  cam.rotX = parseFloat(q('rotX').value) * Math.PI / 180;
  cam.rotY = parseFloat(q('rotY').value) * Math.PI / 180;
  cam.scale = view.width / (cam.dist * 0.8);
  q('zoomLabel').textContent = `المسافة: ${(cam.dist/1e9).toFixed(1)} Gm`;
}

q('zoomRange').oninput = updateCamera;
q('rotX').oninput = updateCamera;
q('rotY').oninput = updateCamera;
updateCamera();

// إسقاط 3D إلى 2D
function project(x, y, z){
  const cx = Math.cos(cam.rotY), sx = Math.sin(cam.rotY);
  const cy = Math.cos(cam.rotX), sy = Math.sin(cam.rotX);
  
  const x1 = x * cx - y * sx;
  const y1 = x * sx + y * cx;
  const z1 = z;
  
  const y2 = y1 * cy - z1 * sy;
  const z2 = y1 * sy + z1 * cy + cam.dist;
  
  if(z2 <= 0) return null;
  
  const scale = cam.scale * (cam.dist / z2);
  return [
    view.width/2 + x1 * scale,
    view.height/2 - y2 * scale,
    z2
  ];
}

// سحب
let dragging = false, lastX = 0, lastY = 0;
view.addEventListener('mousedown', e => { dragging = true; lastX = e.clientX; lastY = e.clientY; });
window.addEventListener('mouseup', () => dragging = false);
window.addEventListener('mousemove', e => {
  if(!dragging) return;
  q('rotY').value = parseFloat(q('rotY').value) + (e.clientX - lastX) * 0.5;
  q('rotX').value = parseFloat(q('rotX').value) - (e.clientY - lastY) * 0.5;
  lastX = e.clientX; lastY = e.clientY;
  updateCamera();
});
view.addEventListener('wheel', e => {
  q('zoomRange').value = parseFloat(q('zoomRange').value) - e.deltaY * 0.1;
  updateCamera();
}, {passive: true});

// === أدوات ===
const v2 = (x,y,z)=>x*x+y*y+z*z;
const mag = (x,y,z)=>Math.sqrt(x*x+y*y+z*z);
const clamp = (v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const palette = ["#58a6ff","#ff7b72","#8ddb8c","#f2cc60","#c39df3","#76e4f7","#f78fb3","#a8d1ff"]; 
const randColor=()=> palette[Math.floor(Math.random()*palette.length)];

// === أجسام ===
function addBody({name, mass, radius, x, y, z, vx, vy, vz, color}){
  bodies.push({name, mass, radius:Math.max(radius, 1e6), x, y, z:z||0, vx, vy, vz:vz||0, color:color||randColor(), trail:[]});
  refreshTrackList();
}
function clearBodies(){ bodies.length=0; refreshTrackList(); }

// === Presets ===
function presetSolar(){
  clearBodies();
  addBody({name:'Sun', mass:1.989e30, radius:6.96e8, x:0, y:0, z:0, vx:0, vy:0, vz:0, color:'#f6d365'});
  addBody({name:'Earth', mass:5.972e24, radius:6.371e6, x:1.496e11, y:0, z:0, vx:0, vy:29780, vz:0, color:'#58a6ff'});
  addBody({name:'Mars', mass:6.39e23, radius:3.389e6, x:2.279e11, y:0, z:0, vx:0, vy:24070, vz:0, color:'#ff7b72'});
}
function presetBinary(){
  clearBodies();
  const M=2e30, r=7e10, v=16000;
  addBody({name:'A', mass:M, radius:7e8, x:-r, y:0, z:0, vx:0, vy:-v, vz:0, color:'#ffd166'});
  addBody({name:'B', mass:M, radius:7e8, x:r, y:0, z:0, vx:0, vy:v, vz:0, color:'#76e4f7'});
}
function presetThree(){
  clearBodies();
  addBody({name:'A', mass:1e26, radius:1e6, x:-3e8, y:0, z:0, vx:0, vy:1.7e3, vz:0});
  addBody({name:'B', mass:1e26, radius:1e6, x:3e8, y:0, z:0, vx:0, vy:-1.7e3, vz:0});
  addBody({name:'C', mass:1e26, radius:1e6, x:0, y:5.2e8, z:0, vx:-1.9e3, vy:0, vz:0});
}
function presetBHStar(){
  clearBodies();
  addBody({name:'BH', mass:5e30, radius:1e5, x:0, y:0, z:0, vx:0, vy:0, vz:0, color:'#c39df3'});
  addBody({name:'Star', mass:2e30, radius:7e8, x:2.5e11, y:0, z:0, vx:0, vy:15000, vz:0, color:'#ffd166'});
}
function presetRandom(n=20){
  clearBodies();
  for(let i=0;i<n;i++){
    const r = 1e11 + Math.random()*3e11;
    const theta = Math.random()*Math.PI*2;
    const phi = Math.acos(2*Math.random()-1);
    const x = r*Math.sin(phi)*Math.cos(theta);
    const y = r*Math.sin(phi)*Math.sin(theta);
    const z = r*Math.cos(phi)*0.3;
    const mass = 1e24 + Math.random()*1e27;
    const speed = Math.sqrt(G*1e30/r)* (0.6+Math.random()*0.8);
    const vx = -speed*Math.sin(theta);
    const vy = speed*Math.cos(theta);
    addBody({name:'B'+i, mass, radius: Math.cbrt(mass)*50, x, y, z, vx, vy, vz:0});
  }
  addBody({name:'Center', mass:1e30, radius:1e9, x:0, y:0, z:0, vx:0, vy:0, vz:0, color:'#f6d365'});
}

function loadPreset(key){
  if(key==='solar') presetSolar();
  else if(key==='binary') presetBinary();
  else if(key==='three') presetThree();
  else if(key==='bhStar') presetBHStar();
  else if(key==='random') presetRandom(20);
  time=0;
  for(const b of bodies) b.trail.length = 0;
  hist.E.length = 0; hist.Lz.length = 0;
}

// === فيزياء ===
function accelerations(pn){
  const n=bodies.length;
  const ax=new Float64Array(n), ay=new Float64Array(n), az=new Float64Array(n);
  for(let i=0;i<n;i++){
    const bi=bodies[i];
    for(let j=i+1;j<n;j++){
      const bj=bodies[j];
      const dx=bj.x-bi.x, dy=bj.y-bi.y, dz=bj.z-bi.z;
      const r2=dx*dx+dy*dy+dz*dz; const r=Math.sqrt(r2)+1e-12;
      let F = G*bi.mass*bj.mass/(r2);
      if(pn){
        const v1=v2(bi.vx,bi.vy,bi.vz), v2j=v2(bj.vx,bj.vy,bj.vz);
        F *= (1 + (v1+v2j)/(2*C*C)) * (1 + 3*G*(bi.mass+bj.mass)/(r*C*C));
      }
      const fx=F*dx/r, fy=F*dy/r, fz=F*dz/r;
      ax[i]+=fx/bi.mass; ay[i]+=fy/bi.mass; az[i]+=fz/bi.mass;
      ax[j]-=fx/bj.mass; ay[j]-=fy/bj.mass; az[j]-=fz/bj.mass;
    }
  }
  return {ax,ay,az};
}

function rk4Step(dt, usePN){
  const n=bodies.length;
  const x0=bodies.map(b=>b.x), y0=bodies.map(b=>b.y), z0=bodies.map(b=>b.z);
  const vx0=bodies.map(b=>b.vx), vy0=bodies.map(b=>b.vy), vz0=bodies.map(b=>b.vz);
  
  let {ax:ax1, ay:ay1, az:az1} = accelerations(usePN);
  for(let i=0;i<n;i++){
    bodies[i].x = x0[i] + 0.5*dt*vx0[i];
    bodies[i].y = y0[i] + 0.5*dt*vy0[i];
    bodies[i].z = z0[i] + 0.5*dt*vz0[i];
    bodies[i].vx = vx0[i] + 0.5*dt*ax1[i];
    bodies[i].vy = vy0[i] + 0.5*dt*ay1[i];
    bodies[i].vz = vz0[i] + 0.5*dt*az1[i];
  }
  
  let {ax:ax2, ay:ay2, az:az2} = accelerations(usePN);
  const vx1=bodies.map(b=>b.vx), vy1=bodies.map(b=>b.vy), vz1=bodies.map(b=>b.vz);
  for(let i=0;i<n;i++){
    bodies[i].x = x0[i] + 0.5*dt*vx1[i];
    bodies[i].y = y0[i] + 0.5*dt*vy1[i];
    bodies[i].z = z0[i] + 0.5*dt*vz1[i];
    bodies[i].vx = vx0[i] + 0.5*dt*ax2[i];
    bodies[i].vy = vy0[i] + 0.5*dt*ay2[i];
    bodies[i].vz = vz0[i] + 0.5*dt*az2[i];
  }
  
  let {ax:ax3, ay:ay3, az:az3} = accelerations(usePN);
  const vx2=bodies.map(b=>b.vx), vy2=bodies.map(b=>b.vy), vz2=bodies.map(b=>b.vz);
  for(let i=0;i<n;i++){
    bodies[i].x = x0[i] + dt*vx2[i];
    bodies[i].y = y0[i] + dt*vy2[i];
    bodies[i].z = z0[i] + dt*vz2[i];
    bodies[i].vx = vx0[i] + dt*ax3[i];
    bodies[i].vy = vy0[i] + dt*ay3[i];
    bodies[i].vz = vz0[i] + dt*az3[i];
  }
  
  let {ax:ax4, ay:ay4, az:az4} = accelerations(usePN);
  
  for(let i=0;i<n;i++){
    bodies[i].vx = vx0[i] + dt*(ax1[i] + 2*ax2[i] + 2*ax3[i] + ax4[i])/6;
    bodies[i].vy = vy0[i] + dt*(ay1[i] + 2*ay2[i] + 2*ay3[i] + ay4[i])/6;
    bodies[i].vz = vz0[i] + dt*(az1[i] + 2*az2[i] + 2*az3[i] + az4[i])/6;
    bodies[i].x = x0[i] + dt*(vx0[i] + 2*vx1[i] + 2*vx2[i] + vx2[i])/6;
    bodies[i].y = y0[i] + dt*(vy0[i] + 2*vy1[i] + 2*vy2[i] + vy2[i])/6;
    bodies[i].z = z0[i] + dt*(vz0[i] + 2*vz1[i] + 2*vz2[i] + vz2[i])/6;
  }
}

function integrateAdaptive(baseDt){
  rk4Step(baseDt*state.speedMul, state.pn);
  time += baseDt*state.speedMul;
  return baseDt;
}

function handleCollisions(){
  if(state.collision==='none') return;
  const removed=[];
  for(let i=0;i<bodies.length;i++){
    for(let j=i+1;j<bodies.length;j++){
      const bi=bodies[i], bj=bodies[j];
      const r=mag(bj.x-bi.x, bj.y-bi.y, bj.z-bi.z);
      if(r <= bi.radius + bj.radius && state.collision==='merge'){
        const M = bi.mass + bj.mass;
        bi.vx = (bi.vx*bi.mass + bj.vx*bj.mass)/M;
        bi.vy = (bi.vy*bi.mass + bj.vy*bj.mass)/M;
        bi.vz = (bi.vz*bi.mass + bj.vz*bj.mass)/M;
        bi.x = (bi.x*bi.mass + bj.x*bj.mass)/M;
        bi.y = (bi.y*bi.mass + bj.y*bj.mass)/M;
        bi.z = (bi.z*bi.mass + bj.z*bj.mass)/M;
        bi.mass = M;
        bi.radius = Math.cbrt(Math.pow(bi.radius,3)+Math.pow(bj.radius,3));
        bi.name = bi.name+"+"+bj.name;
        removed.push(j);
      }
    }
  }
  removed.sort((a,b)=>b-a).forEach(idx=>bodies.splice(idx,1));
  if(removed.length) refreshTrackList();
}

function energyAndAngMom(){
  let KE=0, PE=0, Lz=0;
  for(const b of bodies) KE += 0.5*b.mass*v2(b.vx,b.vy,b.vz);
  for(let i=0;i<bodies.length;i++){
    for(let j=i+1;j<bodies.length;j++){
      const r=mag(bodies[j].x-bodies[i].x, bodies[j].y-bodies[i].y, bodies[j].z-bodies[i].z)+1e-12;
      PE += -G*bodies[i].mass*bodies[j].mass/r;
    }
  }
  for(const b of bodies) Lz += b.mass*(b.x*b.vy - b.y*b.vx);
  return {E:KE+PE, KE, PE, Lz};
}

// === رسم ===
const trailMax = 400;
function pushTrail(){
  if(!state.trails) return;
  for(const b of bodies){
    const p = project(b.x, b.y, b.z);
    if(p) b.trail.push(p);
    if(b.trail.length > trailMax) b.trail.shift();
  }
}

function render(){
  ctx.fillStyle = '#0b0f16';
  ctx.fillRect(0, 0, view.width, view.height);
  
  // شبكة
  if(state.showGrid){
    ctx.strokeStyle = '#1f2a3d';
    ctx.lineWidth = 0.5;
    const gridSize = 10;
    const gridSpacing = cam.dist * 0.15;
    for(let i=-gridSize; i<=gridSize; i++){
      const p1 = project(i*gridSpacing, -gridSize*gridSpacing, 0);
      const p2 = project(i*gridSpacing, gridSize*gridSpacing, 0);
      if(p1 && p2){
        ctx.beginPath();
        ctx.moveTo(p1[0], p1[1]);
        ctx.lineTo(p2[0], p2[1]);
        ctx.stroke();
      }
      const p3 = project(-gridSize*gridSpacing, i*gridSpacing, 0);
      const p4 = project(gridSize*gridSpacing, i*gridSpacing, 0);
      if(p3 && p4){
        ctx.beginPath();
        ctx.moveTo(p3[0], p3[1]);
        ctx.lineTo(p4[0], p4[1]);
        ctx.stroke();
      }
    }
  }
  
  // مسارات
  if(state.trails){
    for(const b of bodies){
      if(b.trail.length < 2) continue;
      ctx.strokeStyle = b.color;
      ctx.lineWidth = 1.5;
      ctx.globalAlpha = 0.6;
      ctx.beginPath();
      ctx.moveTo(b.trail[0][0], b.trail[0][1]);
      for(let i=1; i<b.trail.length; i++){
        ctx.lineTo(b.trail[i][0], b.trail[i][1]);
      }
      ctx.stroke();
      ctx.globalAlpha = 1;
    }
  }
  
  // رسم الأجسام مرتبة حسب العمق
  const sorted = bodies.map(b => {
    const p = project(b.x, b.y, b.z);
    return {b, p};
  }).filter(x => x.p).sort((a,b) => b.p[2] - a.p[2]);
  
  for(const {b, p} of sorted){
    const size = Math.max(2, Math.min(50, b.radius * cam.scale * (cam.dist / p[2])));
    
    // توهج
    const grad = ctx.createRadialGradient(p[0], p[1], 0, p[0], p[1], size*1.5);
    grad.addColorStop(0, b.color);
    grad.addColorStop(0.7, b.color + '80');
    grad.addColorStop(1, b.color + '00');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(p[0], p[1], size*1.5, 0, Math.PI*2);
    ctx.fill();
    
    // الجسم
    ctx.fillStyle = b.color;
    ctx.beginPath();
    ctx.arc(p[0], p[1], size, 0, Math.PI*2);
    ctx.fill();
  }
  
  // تتبع
  const tracked = q('track').value;
  if(tracked){
    const b = bodies.find(x => x.name === tracked);
    if(b){
      const p = project(b.x, b.y, b.z);
      if(p){
        ctx.strokeStyle = 'rgba(255,255,255,0.5)';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        const size = Math.max(2, Math.min(50, b.radius * cam.scale * (cam.dist / p[2])));
        ctx.arc(p[0], p[1], size + 10, 0, Math.PI*2);
        ctx.stroke();
        ctx.setLineDash([]);
      }
    }
  }
}

function renderHUD(){
  hudStats.innerHTML='';
  const {E,KE,PE,Lz} = energyAndAngMom();
  const row=(k,v)=>{ 
    const dv=document.createElement('div'); 
    dv.textContent=k; 
    hudStats.appendChild(dv); 
    const vv=document.createElement('div'); 
    vv.textContent=v; 
    hudStats.appendChild(vv); 
  };
  row('الأجسام', bodies.length);
  row('الزمن', time.toExponential(2) + ' ث');
  row('Δt', currentDt.toExponential(2));
  row('الطاقة', E.toExponential(3));
  row('Lz', Lz.toExponential(3));
  row('PN', state.pn ? 'نعم':'لا');
  drawChart(E,Lz);
  renderBodyCards();
}

const hist = {E:[], Lz:[], max:300};
function drawChart(E,Lz){
  hist.E.push(E); hist.Lz.push(Lz);
  if(hist.E.length>hist.max){ hist.E.shift(); hist.Lz.shift(); }
  cctx.clearRect(0,0,chart.width,chart.height);
  const pad=6, w=chart.width-2*pad, h=chart.height-2*pad;
  const n=hist.E.length; if(n<2) return;
  const minE=Math.min(...hist.E), maxE=Math.max(...hist.E);
  const minL=Math.min(...hist.Lz), maxL=Math.max(...hist.Lz);
  const map = (v,lo,hi)=> pad + (1 - (v-lo)/((hi-lo)||1)) * h;
  const step=w/(n-1);
  
  cctx.strokeStyle='#7ee787'; cctx.lineWidth=1.5; cctx.beginPath();
  for(let i=0;i<n;i++){ 
    const x=pad+i*step, y=map(hist.E[i],minE,maxE); 
    if(i===0) cctx.moveTo(x,y); else cctx.lineTo(x,y); 
  }
  cctx.stroke();
  
  cctx.strokeStyle='#59c1ff'; cctx.lineWidth=1.5; cctx.beginPath();
  for(let i=0;i<n;i++){ 
    const x=pad+i*step, y=map(hist.Lz[i],minL,maxL); 
    if(i===0) cctx.moveTo(x,y); else cctx.lineTo(x,y); 
  }
  cctx.stroke();
}

// UI
q('btnPlay').onclick = ()=>{ 
  running=!running; 
  q('btnPlay').textContent = running? '⏸ إيقاف':'▶ تشغيل'; 
};
q('btnStep').onclick = ()=>{ stepOnce(); render(); renderHUD(); };
q('btnReset').onclick = ()=>{ loadPreset(q('preset').value); };
q('btnLoadPreset').onclick = ()=> loadPreset(q('preset').value);
q('btnCSV').onclick = ()=>{
  let csv = 'time,name,x,y,z,vx,vy,vz\n';
  for(const b of bodies) csv += `${time},${b.name},${b.x},${b.y},${b.z},${b.vx},${b.vy},${b.vz}\n`;
  const blob = new Blob([csv], {type:'text/csv'});
  const a=document.createElement('a'); 
  a.href=URL.createObjectURL(blob); 
  a.download='snapshot.csv'; 
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
};
q('btnAdd').onclick = ()=>{
  addBody({
    name:q('bName').value||('B'+(bodies.length+1)),
    mass:parseFloat(q('bMass').value)||1e24, 
    radius:Math.max(1e6, parseFloat(q('bMass').value)**(1/3)*100),
    x:parseFloat(q('bX').value)||0, 
    y:parseFloat(q('bY').value)||0,
    z:parseFloat(q('bZ').value)||0,
    vx:parseFloat(q('bVX').value)||0, 
    vy:parseFloat(q('bVY').value)||0,
    vz:parseFloat(q('bVZ').value)||0
  });
};
q('btnClear').onclick = ()=>{ clearBodies(); time=0; };

q('adaptive').onchange = e=> state.adaptive = e.target.checked;
q('enablePN').onchange = e=> state.pn = e.target.checked;
q('showTrails').onchange = e=> { 
  state.trails = e.target.checked; 
  if(!state.trails) for(const b of bodies) b.trail.length = 0;
};
q('showGrid').onchange = e=> state.showGrid = e.target.checked;
q('speedMul').onchange = e=> state.speedMul = parseFloat(e.target.value) || 1;
q('dt').onchange = e=> state.dt = parseFloat(e.target.value) || 1;
q('collisionMode').onchange = e=> state.collision = e.target.value;

document.addEventListener('keydown', e=>{
  if(e.code==='Space'){ 
    e.preventDefault(); 
    running=!running; 
    q('btnPlay').textContent = running? '⏸ إيقاف':'▶ تشغيل'; 
  }
});

function refreshTrackList(){
  const sel = q('track'), v=sel.value; 
  sel.innerHTML='';
  sel.appendChild(new Option('بدون', ''));
  for(const b of bodies) sel.appendChild(new Option(b.name, b.name));
  sel.value = v && bodies.find(x=>x.name===v) ? v : '';
  renderBodyCards();
}

function renderBodyCards(){
  if(!cardsRoot) return;
  cardsRoot.innerHTML='';
  const tracked = q('track').value;
  for(const b of bodies){
    const card = document.createElement('div');
    card.className = 'card' + (tracked===b.name ? ' selected' : '');
    const speed = mag(b.vx,b.vy,b.vz);
    const r = mag(b.x,b.y,b.z);
    const gamma = 1/Math.sqrt(Math.max(0.001, 1-Math.min(speed*speed, C*C)/(C*C)));
    card.innerHTML = `
      <h4>
        <span>${b.name}</span>
        <span class="badgeSmall">γ=${gamma.toFixed(3)}</span>
      </h4>
      <div class="meta">
        <div>m:</div><div>${b.mass.toExponential(1)}</div>
        <div>|r|:</div><div>${r.toExponential(2)}</div>
        <div>|v|:</div><div>${speed.toExponential(2)}</div>
      </div>
      <div class="rowBtns">
        <button data-act="track">تتبع</button>
        <button data-act="boost">دفعة</button>
      </div>`;
    card.querySelector('[data-act="track"]').onclick = ()=>{ q('track').value=b.name; };
    card.querySelector('[data-act="boost"]').onclick = ()=>{ 
      b.vx*=1.1; b.vy*=1.1; b.vz*=1.1; 
    };
    cardsRoot.appendChild(card);
  }
}

function stepOnce(){
  currentDt = integrateAdaptive(state.dt);
  handleCollisions();
  pushTrail();
}

function loop(){ 
  if(running) stepOnce(); 
  render(); 
  renderHUD(); 
  requestAnimationFrame(loop); 
}

// بدء
loadPreset('solar');
loop();
  </script>
</body>
</html>
